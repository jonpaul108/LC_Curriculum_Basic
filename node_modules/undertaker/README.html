<p>&lt;p align=&quot;center&quot;&gt;
&lt;a href=&quot;http://gulpjs.com&quot;&gt;
&lt;img height=&quot;257&quot; width=&quot;114&quot; src=&quot;https://raw.githubusercontent.com/gulpjs/artwork/master/gulp-2x.png&quot;&gt;
&lt;/a&gt;
&lt;/p&gt;</p>
<h1>undertaker</h1>
<p><a href="https://www.npmjs.com/package/undertaker"><img src="https://img.shields.io/npm/v/undertaker.svg" alt="NPM version"></a> <a href="https://www.npmjs.com/package/undertaker"><img src="https://img.shields.io/npm/dm/undertaker.svg" alt="Downloads"></a> <a href="https://dev.azure.com/gulpjs/gulp/_build/latest?definitionId=$PROJECT_ID&amp;branchName=master"><img src="https://dev.azure.com/gulpjs/gulp/_apis/build/status/undertaker?branchName=master" alt="Azure Pipelines Build Status"></a> <a href="https://travis-ci.org/gulpjs/undertaker"><img src="https://img.shields.io/travis/gulpjs/undertaker.svg?label=travis-ci" alt="Travis Build Status"></a> <a href="https://ci.appveyor.com/project/gulpjs/undertaker"><img src="https://img.shields.io/appveyor/ci/gulpjs/undertaker.svg?label=appveyor" alt="AppVeyor Build Status"></a> <a href="https://coveralls.io/r/gulpjs/undertaker"><img src="https://img.shields.io/coveralls/gulpjs/undertaker/master.svg" alt="Coveralls Status"></a> <a href="https://gitter.im/gulpjs/gulp"><img src="https://badges.gitter.im/gulpjs/gulp.svg" alt="Gitter chat"></a></p>
<h2>Usage</h2>
<pre><code class="language-js">var fs = require('fs');
var Undertaker = require('undertaker');

var taker = new Undertaker();

taker.task('task1', function(cb){
  // do things

  cb(); // when everything is done
});

taker.task('task2', function(){
  return fs.createReadStream('./myFile.js')
    .pipe(fs.createWriteStream('./myFile.copy.js'));
});

taker.task('task3', function(){
  return new Promise(function(resolve, reject){
    // do things

    resolve(); // when everything is done
  });
});

taker.task('combined', taker.series('task1', 'task2'));

taker.task('all', taker.parallel('combined', 'task3'));
</code></pre>
<h2>API</h2>
<p><strong>Task functions can be completed in any of the ways supported by
<a href="https://github.com/phated/async-done#completion-and-error-resolution"><code>async-done</code></a></strong></p>
<h3><code>new Undertaker([registryInstance])</code></h3>
<p>The constructor is used to create a new instance of <code>Undertaker</code>. Each instance of
<code>Undertaker</code> gets its own instance of a registry. By default, the registry is an
instance of <a href="https://github.com/gulpjs/undertaker-registry"><code>undertaker-registry</code></a>
but it can be an instance of any other registry that follows the <a href="#custom-registries">Custom Registries API</a>.</p>
<p>To use a custom registry, pass a custom registry instance (<code>new CustomRegistry([options])</code>) when
instantiating a new <code>Undertaker</code> instance. This will use the custom registry instance for that <code>Undertaker</code> instance.</p>
<h3><code>task([taskName,] fn)</code></h3>
<p>Both a <code>getter</code> and <code>setter</code> for tasks.</p>
<p>If a string (<code>taskName</code>) is given as the only argument, it behaves as a <code>getter</code>
and returns the wrapped task (not the original function). The wrapped task has a <code>unwrap</code>
method that will return the original function.</p>
<p>If a function (<code>fn</code>) and optionally a string (<code>taskName</code>) is given, it behaves as
a <code>setter</code> and will register the task by the <code>taskName</code>.  If <code>taskName</code> is not
specified, the <code>name</code> or <code>displayName</code> property of the function is used as the <code>taskName</code>.</p>
<p>Will throw if:</p>
<ul>
<li>As a <code>getter</code>: <code>taskName</code> is missing or not a string.</li>
<li>As a <code>setter</code>: <code>taskName</code> is missing and <code>fn</code> is anonymous.</li>
<li>As a <code>setter</code>: <code>fn</code> is missing or not a function.</li>
</ul>
<h3><code>series(taskName || fn...)</code></h3>
<p>Takes a variable amount of strings (<code>taskName</code>) and/or functions (<code>fn</code>) and
returns a function of the composed tasks or functions. Any <code>taskNames</code> are
retrieved from the registry using the <code>get</code> method.</p>
<p>When the returned function is executed, the tasks or functions will be executed
in series, each waiting for the prior to finish. If an error occurs, execution
will stop.</p>
<h3><code>parallel(taskName || fn...)</code></h3>
<p>Takes a variable amount of strings (<code>taskName</code>) and/or functions (<code>fn</code>) and
returns a function of the composed tasks or functions. Any <code>taskNames</code> are
retrieved from the registry using the <code>get</code> method.</p>
<p>When the returned function is executed, the tasks or functions will be executed
in parallel, all being executed at the same time. If an error occurs, all execution
will complete.</p>
<h3><code>registry([registryInstance])</code></h3>
<p>Optionally takes an instantiated registry object. If no arguments are passed, returns
the current registry object. If an instance of a registry (<code>customRegistry</code>) is passed
the tasks from the current registry will be transferred to it and the current registry
will be replaced with the new registry.</p>
<p>The ability to assign new registries will allow you to pre-define/share tasks or add
custom functionality to your registries. See <a href="#custom-registries">Custom Registries</a>
for more information.</p>
<h3><code>tree([options])</code></h3>
<p>Optionally takes an <code>options</code> object and returns an object representing the
tree of registered tasks. The object returned is <a href="https://www.npmjs.org/package/archy"><code>archy</code></a>
compatible. Also, each node has a <code>type</code> property that can be used to determine if the node is a <code>task</code> or <code>function</code>.</p>
<h4><code>options</code></h4>
<h5><code>options.deep</code></h5>
<p>Whether or not the whole tree should be returned.</p>
<p>Type: <code>Boolean</code></p>
<p>Default: <code>false</code></p>
<h3><code>lastRun(task, [precision])</code></h3>
<p>Takes a string or function (<code>task</code>) and returns a timestamp of the last time the task
was run successfully. The time will be the time the task started.</p>
<p>Returns <code>undefined</code> if the task has not been run.</p>
<p>If a task errors, the result of <code>lastRun</code> will be undefined because the task
should probably be re-run from scratch to get into a good state again.</p>
<p>The timestamp is always given in millisecond but the time resolution can be
rounded using the <code>precision</code> parameter. The use case is to be able to compare a build time
to a file time attribute. On node v0.10 or with file system like HFS or FAT,
<code>fs.stat</code> time attributes like <code>mtime</code> precision is one second.</p>
<p>Assuming <code>undertakerInst.lastRun('someTask')</code> returns <code>1426000001111</code>,
<code>undertakerInst.lastRun('someTask', 1000)</code> returns <code>1426000001000</code>.</p>
<p>The default time resolution is <code>1000</code> on node v0.10, <code>0</code> on node 0.11+ but
it can be overwritten using <code>UNDERTAKER_TIME_RESOLUTION</code> environment variable.</p>
<h2>Custom Registries</h2>
<p>Custom registries are constructor functions allowing you to pre-define/share tasks
or add custom functionality to your registries.</p>
<p>A registry's prototype should define:</p>
<ul>
<li><code>init(taker)</code>: receives the undertaker instance to set pre-defined tasks using the <code>task(taskName, fn)</code> method.</li>
<li><code>get(taskName)</code>: returns the task with that name
or <code>undefined</code> if no task is registered with that name.</li>
<li><code>set(taskName, fn)</code>: add task to the registry. If <code>set</code> modifies a task, it should return the new task.</li>
<li><code>tasks()</code>: returns an object listing all tasks in the registry.</li>
</ul>
<p>You should not call these functions yourself; leave that to Undertaker, so it can
keep its metadata consistent.</p>
<p>The easiest way to create a custom registry is to inherit from <a href="https://github.com/gulpjs/undertaker-registry">undertaker-registry</a>:</p>
<pre><code class="language-js">var util = require('util');

var DefaultRegistry = require('undertaker-registry');

function MyRegistry(){
  DefaultRegistry.call(this);
}

util.inherits(MyRegistry, DefaultRegistry);

module.exports = MyRegistry;
</code></pre>
<h3>Sharing tasks</h3>
<p>To share common tasks with all your projects, you can expose an <code>init</code> method on the registry
prototype and it will receive the <code>Undertaker</code> instance as the only argument. You can then use
<code>undertaker.task(name, fn)</code> to register pre-defined tasks.</p>
<p>For example you might want to share a <code>clean</code> task:</p>
<pre><code class="language-js">var fs = require('fs');
var util = require('util');

var DefaultRegistry = require('undertaker-registry');
var del = require('del');

function CommonRegistry(opts){
  DefaultRegistry.call(this);

  opts = opts || {};

  this.buildDir = opts.buildDir || './build';
}

util.inherits(CommonRegistry, DefaultRegistry);

CommonRegistry.prototype.init = function(takerInst){
  var buildDir = this.buildDir;
  var exists = fs.existsSync(buildDir);

  if(exists){
    throw new Error('Cannot initialize common tasks. ' + buildDir + ' directory exists.');
  }

  takerInst.task('clean', function(){
    return del([buildDir]);
  });
}

module.exports = CommonRegistry;
</code></pre>
<p>Then to use it in a project:</p>
<pre><code class="language-js">var Undertaker = require('undertaker');
var CommonRegistry = require('myorg-common-tasks');

var taker = new Undertaker(CommonRegistry({ buildDir: '/dist' }));

taker.task('build', taker.series('clean', function build(cb) {
  // do things
  cb();
}));
</code></pre>
<h3>Sharing Functionalities</h3>
<p>By controlling how tasks are added to the registry, you can decorate them.</p>
<p>For example if you wanted all tasks to share some data,  you can use a custom registry
to bind them to that data. Be sure to return the altered task, as per the description
of registry methods above:</p>
<pre><code class="language-js">var util = require('util');

var Undertaker = require('undertaker');
var DefaultRegistry = require('undertaker-registry');

// Some task defined somewhere else
var BuildRegistry = require('./build.js');
var ServeRegistry = require('./serve.js');

function ConfigRegistry(config){
  DefaultRegistry.call(this);
  this.config = config;
}

util.inherits(ConfigRegistry, DefaultRegistry);

ConfigRegistry.prototype.set = function set(name, fn) {
  // The `DefaultRegistry` uses `this._tasks` for storage.
  var task = this._tasks[name] = fn.bind(this.config);
  return task;
};

var taker = new Undertaker();

taker.registry(new BuildRegistry());
taker.registry(new ServeRegistry());

// `taker.registry` will reset each task in the registry with
// `ConfigRegistry.prototype.set` which will bind them to the config object.
taker.registry(new ConfigRegistry({
  src: './src',
  build: './build',
  bindTo: '0.0.0.0:8888'
}));

taker.task('default', taker.series('clean', 'build', 'serve', function(cb) {
  console.log('Server bind to ' + this.bindTo);
  console.log('Serving' + this.build);
  cb();
}));
</code></pre>
<h3>In the wild</h3>
<ul>
<li><a href="https://github.com/gulpjs/undertaker-registry">undertaker-registry</a> - Custom registries probably want to inherit from this.</li>
<li><a href="https://github.com/gulpjs/undertaker-forward-reference">undertaker-forward-reference</a> - Custom registry supporting forward referenced tasks (similar to gulp 3.x).</li>
<li><a href="https://github.com/gulpjs/undertaker-task-metadata">undertaker-task-metadata</a> - Proof-of-concept custom registry that attaches metadata to each task.</li>
<li><a href="https://github.com/gulpjs/undertaker-common-tasks">undertaker-common-tasks</a> - Proof-of-concept custom registry that pre-defines some tasks.</li>
<li><a href="https://github.com/webdesserts/alchemist-gulp">alchemist-gulp</a> - A default set of tasks for building alchemist plugins.</li>
<li><a href="https://github.com/frankwallis/gulp-hub/tree/registry-init">gulp-hub</a> - Custom registry to run tasks in multiple gulpfiles. (In a branch as of this writing)</li>
<li><a href="https://github.com/alienfast/gulp-pipeline">gulp-pipeline</a> - <a href="https://github.com/alienfast/gulp-pipeline/blob/master/src/registry/railsRegistry.js">RailsRegistry</a> is an ES2015 class that provides a gulp pipeline replacement for rails applications</li>
</ul>
<h2>License</h2>
<p>MIT</p>
